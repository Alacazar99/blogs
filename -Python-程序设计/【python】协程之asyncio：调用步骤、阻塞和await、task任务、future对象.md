#### é¦–å…ˆä»‹ç»ä¸€ä¸‹ åå‡½æ•°

å¦‚æœéœ€è¦å‡å°‘æŸä¸ªå‡½æ•°çš„å‚æ•°ä¸ªæ•°ï¼Œä½ å¯ä»¥ä½¿ç”¨ 
- functools.partial()

ã€ä½œç”¨ä¸€ã€‘:partial() å‡½æ•°å…è®¸ä½ ç»™**ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°**è®¾ç½®å›ºå®šçš„å€¼ï¼Œå‡å°‘æ¥ä¸‹æ¥è¢«è°ƒç”¨æ—¶çš„å‚æ•°ä¸ªæ•°ã€‚


ã€ä½œç”¨äºŒã€‘:partial() ç”¨äºå›ºå®šæŸäº›å‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„callableå¯¹è±¡ã€‚

---

#### å…³äºåç¨‹çš„è°ƒç”¨æ­¥éª¤
ä¸‹é¢å°†ç®€å•ä»‹ç»asyncioçš„ä½¿ç”¨ã€‚
- ğŸŒ°**event_loop äº‹ä»¶å¾ªç¯**ï¼šç¨‹åºå¼€å¯ä¸€ä¸ªæ— é™çš„å¾ªç¯ï¼Œç¨‹åºå‘˜ä¼šæŠŠä¸€äº›å‡½æ•°æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯ä¸Šã€‚å½“æ»¡è¶³äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ï¼Œè°ƒç”¨ç›¸åº”çš„åç¨‹å‡½æ•°ã€‚
- ğŸŒ°**coroutine åç¨‹**ï¼šåç¨‹å¯¹è±¡ï¼ŒæŒ‡ä¸€ä¸ªä½¿ç”¨asyncå…³é”®å­—å®šä¹‰çš„å‡½æ•°ï¼Œå®ƒçš„è°ƒç”¨ä¸ä¼šç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œè€Œæ˜¯ä¼šè¿”å›ä¸€ä¸ªåç¨‹å¯¹è±¡ã€‚åç¨‹å¯¹è±¡éœ€è¦æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯ï¼Œç”±äº‹ä»¶å¾ªç¯è°ƒç”¨ã€‚
- ğŸŒ°**task ä»»åŠ¡**ï¼šä¸€ä¸ªåç¨‹å¯¹è±¡å°±æ˜¯ä¸€ä¸ªåŸç”Ÿå¯ä»¥æŒ‚èµ·çš„å‡½æ•°ï¼Œä»»åŠ¡åˆ™æ˜¯å¯¹åç¨‹è¿›ä¸€æ­¥å°è£…ï¼Œå…¶ä¸­åŒ…å«ä»»åŠ¡çš„å„ç§çŠ¶æ€ã€‚
- ğŸŒ°**futureå¯¹è±¡**ï¼š ä»£è¡¨å°†æ¥æ‰§è¡Œæˆ–æ²¡æœ‰æ‰§è¡Œçš„ä»»åŠ¡çš„ç»“æœã€‚å®ƒå’Œtaskä¸Šæ²¡æœ‰æœ¬è´¨çš„åŒºåˆ«ï¼›

- ğŸŒ°**async/await å…³é”®å­—**ï¼špython3.5 ç”¨äºå®šä¹‰åç¨‹çš„å…³é”®å­—ï¼Œasyncå®šä¹‰ä¸€ä¸ªåç¨‹ï¼Œawaitç”¨äºæŒ‚èµ·é˜»å¡çš„å¼‚æ­¥è°ƒç”¨æ¥å£ã€‚

###### é‡ç‚¹æ³¨æ„:
1.å½“æˆ‘ä»¬ç»™ä¸€ä¸ªå‡½æ•°æ·»åŠ äº†asyncå…³é”®å­—ï¼Œæˆ–è€…ä½¿ç”¨asyncio.coroutineè£…é¥°å™¨è£…é¥°ï¼Œå°±ä¼šæŠŠå®ƒå˜æˆä¸€ä¸ªå¼‚æ­¥å‡½æ•°ã€‚ 
2.æ¯ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œä¸»çº¿ç¨‹è°ƒç”¨asyncio.get_event_loopæ—¶ä¼šåˆ›å»ºäº‹ä»¶å¾ªç¯ï¼›

3.å°†ä»»åŠ¡å°è£…ä¸ºé›†åˆasyncio.gather(*args),ä¹‹åä¸€èµ·ä¼ å…¥äº‹ä»¶å¾ªç¯ä¸­ï¼›

4.è¦æŠŠå¼‚æ­¥çš„ä»»åŠ¡ä¸¢ç»™è¿™ä¸ªå¾ªç¯çš„run_until_completeæ–¹æ³•ï¼Œäº‹ä»¶å¾ªç¯ä¼šå®‰æ’ååŒç¨‹åºçš„æ‰§è¡Œã€‚å’Œæ–¹æ³•åå­—ä¸€æ ·ï¼Œè¯¥æ–¹æ³•ä¼šç­‰å¾…å¼‚æ­¥çš„ä»»åŠ¡å®Œå…¨æ‰§è¡Œæ‰ä¼šç»“æŸã€‚

ã€æ³¨é‡Šã€‘å®ç°åç¨‹çš„ä¸ä»…ä»…æ˜¯asyncioï¼Œ**tornadoå’Œgevent**éƒ½èƒ½å®ç°ç±»ä¼¼çš„åŠŸèƒ½ã€‚

æ¥çœ‹ä¸€ä¸ªå®ä¾‹ğŸŒ°ï¼š
```
async def test1():
    print("1")

async def test2():
    print("2")

a = test1()
b = test2()

try:
    a.send(None) # å¯ä»¥é€šè¿‡è°ƒç”¨ send æ–¹æ³•ï¼Œæ‰§è¡Œåç¨‹å‡½æ•°
except StopIteration as e:
    print(e.value)
    # åç¨‹å‡½æ•°æ‰§è¡Œç»“æŸæ—¶ä¼šæŠ›å‡ºä¸€ä¸ªStopIteration å¼‚å¸¸ï¼Œæ ‡å¿—ç€åç¨‹å‡½æ•°æ‰§è¡Œç»“æŸï¼Œè¿”å›å€¼åœ¨valueä¸­
    pass
try:
    b.send(None) # å¯ä»¥é€šè¿‡è°ƒç”¨ send æ–¹æ³•ï¼Œæ‰§è¡Œåç¨‹å‡½æ•°
except StopIteration:
    print(e.value)
    # åç¨‹å‡½æ•°æ‰§è¡Œç»“æŸæ—¶ä¼šæŠ›å‡ºä¸€ä¸ªStopIteration å¼‚å¸¸ï¼Œæ ‡å¿—ç€åç¨‹å‡½æ•°æ‰§è¡Œç»“æŸï¼Œè¿”å›å€¼åœ¨valueä¸­
    pass

---
è¾“å‡ºï¼š
1
2
```
ã€è§£é‡Šã€‘ç¨‹åºå…ˆæ‰§è¡Œäº†test1å‡½æ•°ï¼Œç­‰åˆ°test1å‡½æ•°æ‰§è¡Œå®Œåå†æ‰§è¡Œtest2å‡½æ•°ã€‚ä»æ‰§è¡Œè¿‡ç¨‹ä¸Šæ¥çœ‹ç›®å‰åç¨‹å‡½æ•°ä¸æ™®é€šå‡½æ•°æ²¡æœ‰åŒºåˆ«ï¼Œå¹¶æ²¡æœ‰å®ç°å¼‚æ­¥å‡½æ•°ã€‚

---
#### å…³äºé˜»å¡å’Œawait
ã€æ¦‚å¿µã€‘ä½¿ç”¨`async`å…³é”®å­—å®šä¹‰çš„åç¨‹å¯¹è±¡ï¼Œä½¿ç”¨awaitå¯ä»¥é’ˆå¯¹è€—æ—¶çš„æ“ä½œè¿›è¡ŒæŒ‚èµ·ï¼ˆæ˜¯ç”Ÿæˆå™¨ä¸­çš„yieldçš„æ›¿ä»£ï¼Œä½†æ˜¯æœ¬åœ°åç¨‹å‡½æ•°ä¸å…è®¸ä½¿ç”¨ï¼‰ï¼Œè®©å‡ºå½“å‰æ§åˆ¶æƒã€‚åç¨‹é‡åˆ°awaitï¼Œäº‹ä»¶å¾ªç¯å°†ä¼šæŒ‚èµ·è¯¥åç¨‹ï¼Œ`æ‰§è¡Œåˆ«çš„åç¨‹ï¼Œç›´åˆ°å…¶ä»–åç¨‹ä¹ŸæŒ‚èµ·`ï¼Œæˆ–è€…æ‰§è¡Œå®Œæ¯•ï¼Œåœ¨è¿›è¡Œä¸‹ä¸€ä¸ªåç¨‹çš„æ‰§è¡Œã€‚
```
import asyncio

async def test1():
    print("1")
    await asyncio.sleep(1) # asyncio.sleep(1)è¿”å›çš„ä¹Ÿæ˜¯ä¸€ä¸ªåç¨‹å¯¹è±¡
    print("2")

async def test2():
    print("3")
    print("4")

a = test1()
b = test2()

try:
    a.send(None) # å¯ä»¥é€šè¿‡è°ƒç”¨ send æ–¹æ³•ï¼Œæ‰§è¡Œåç¨‹å‡½æ•°
except StopIteration:
    # åç¨‹å‡½æ•°æ‰§è¡Œç»“æŸæ—¶ä¼šæŠ›å‡ºä¸€ä¸ªStopIteration å¼‚å¸¸ï¼Œæ ‡å¿—ç€åç¨‹å‡½æ•°æ‰§è¡Œç»“æŸ
    pass

try:
    b.send(None) # å¯ä»¥é€šè¿‡è°ƒç”¨ send æ–¹æ³•ï¼Œæ‰§è¡Œåç¨‹å‡½æ•°
except StopIteration:
    pass

---
è¾“å‡ºï¼š
1
3
4
```
ã€è§£é‡Šã€‘ç¨‹åºå…ˆæ‰§è¡Œtest1åç¨‹å‡½æ•°ï¼Œåœ¨æ‰§è¡Œåˆ°awaitæ—¶ï¼Œtest1å‡½æ•°åœæ­¢äº†æ‰§è¡Œï¼ˆé˜»å¡ï¼‰ï¼›æ¥ç€å¼€å§‹æ‰§è¡Œtest2åç¨‹å‡½æ•°ï¼Œç›´åˆ°test2æ‰§è¡Œå®Œæ¯•ã€‚ä»ç»“æœä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç›´åˆ°ç¨‹åºè¿è¡Œå®Œæ¯•ï¼Œtest1å‡½æ•°ä¹Ÿæ²¡æœ‰æ‰§è¡Œå®Œï¼ˆæ²¡æœ‰æ‰§è¡Œprint(â€œ2â€)ï¼‰

---
ã€å¯¹ä¸Šé¢çš„ä»£ç å—è¿›è¡Œä¿®æ”¹ã€‘ï¼Œä½¿å¾—test1å‡½æ•°å®Œå…¨æ‰§è¡Œ
```
import asyncio
async def test1():
    print("1")
    await test2()
    print("2")

async def test2():
    print("3")
    print("4")

loop = asyncio.get_event_loop()
loop.run_until_complete(test1())

---
è¾“å‡ºï¼š
1
3
4
2
```
ã€äº‹ä»¶å¾ªç¯æ–¹æ³•ã€‘**asyncio.get_event_loopæ–¹æ³•**å¯ä»¥åˆ›å»ºä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œç„¶åä½¿ç”¨ **run_until_complete** å°†åç¨‹æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯ï¼Œå¹¶å¯åŠ¨äº‹ä»¶å¾ªç¯ã€‚

ã€æŠ€èƒ½å‡çº§ã€‘ä½¿ç”¨**asyncå¯ä»¥å®šä¹‰åç¨‹å¯¹è±¡**ï¼Œä½¿ç”¨**awaitå¯ä»¥é’ˆå¯¹è€—æ—¶çš„æ“ä½œè¿›è¡ŒæŒ‚èµ·**ï¼Œå°±åƒç”Ÿæˆå™¨é‡Œçš„yieldä¸€æ ·ï¼Œå‡½æ•°è®©å‡ºæ§åˆ¶æƒã€‚åç¨‹é‡åˆ°awaitï¼Œäº‹ä»¶å¾ªç¯å°†ä¼šæŒ‚èµ·è¯¥åç¨‹ï¼Œæ‰§è¡Œåˆ«çš„åç¨‹ï¼Œç›´åˆ°å…¶ä»–çš„åç¨‹ä¹ŸæŒ‚èµ·æˆ–è€…æ‰§è¡Œå®Œæ¯•ï¼Œå†è¿›è¡Œä¸‹ä¸€ä¸ªåç¨‹çš„æ‰§è¡Œï¼Œ**åç¨‹çš„ç›®çš„ä¹Ÿæ˜¯è®©ä¸€äº›è€—æ—¶çš„æ“ä½œå¼‚æ­¥åŒ–**ã€‚

---

#### å…³äºtaskä»»åŠ¡

ç”±äºåç¨‹å¯¹è±¡ä¸èƒ½ç›´æ¥è¿è¡Œï¼Œåœ¨æ³¨å†Œäº‹ä»¶å¾ªç¯çš„æ—¶å€™ï¼Œå…¶å®æ˜¯**run_until_completeæ–¹æ³•**å°†åç¨‹åŒ…è£…æˆä¸ºäº†ä¸€ä¸ªä»»åŠ¡ï¼ˆtaskï¼‰å¯¹è±¡ã€‚æ‰€è°“**taskå¯¹è±¡æ˜¯Futureç±»çš„å­ç±»**ï¼Œä¿å­˜äº†åç¨‹è¿è¡Œåçš„çŠ¶æ€ï¼Œç”¨äºæœªæ¥è·å–åç¨‹çš„ç»“æœã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨å°†åç¨‹å¯¹è±¡å®šä¹‰æˆtaskï¼Œæ”¹è¿›ä»£ç å¦‚ä¸‹ï¼š

ã€å¯¹ä¸Šé¢çš„ä»£ç å—å†ä¸€æ¬¡ä¿®æ”¹ã€‘
```
import asyncio

async def test1():
    print("1")
    await test2()
    print("2")

async def test2():
    print("3")
    print("4")

loop = asyncio.get_event_loop()
task = loop.create_task(test1())
loop.run_until_complete(task)
```
ã€é‡ç‚¹å›é¡¾ã€‘å‰é¢è¯´åˆ°taskå¯¹è±¡ä¿å­˜äº†åç¨‹è¿è¡Œçš„çŠ¶æ€ï¼Œå¹¶ä¸”å¯ä»¥è·å–åç¨‹å‡½æ•°è¿è¡Œçš„è¿”å›å€¼ï¼›

###### å…³äºtaskå¯¹è±¡é‚£ä¹ˆå…·ä½“è¯¥å¦‚ä½•è·å–å‘¢ï¼Ÿ
- éœ€è¦ç»‘å®šå›è°ƒå‡½æ•°

- ç›´æ¥åœ¨è¿è¡Œå®Œtaskä»»åŠ¡åè¾“å‡º

ã€æå‡ã€‘å¦‚æœä½¿ç”¨sendæ–¹æ³•æ‰§è¡Œå‡½æ•°ï¼Œåˆ™è¿”å›å€¼å¯ä»¥é€šè¿‡æ•æ‰StopIterationå¼‚å¸¸ï¼Œåˆ©ç”¨StopIteration.valueè·å–ã€‚

ã€ä¸¾ä¸ªä¾‹å­ã€‘ï¼šğŸŒ°
  ```
import asyncio

async def test_one():
    print("Zurich")
    await test_two()
    print("Alzacar")
    return "stop"

async def test_two():
    print("--")
    print("$$$")

loop = asyncio.get_event_loop()
task = asyncio.ensure_future(test_one())
loop.run_until_complete(task)
print(task.result())

---
ã€Outputã€‘ï¼š
Zurich
Alzacar
--
$$$
```

---
##### ä½¿ç”¨futureå¯¹è±¡

ã€è§£é‡Šã€‘ï¼šfutureå¯¹è±¡æœ‰å‡ ä¸ªçŠ¶æ€ï¼š**Pendingã€Runningã€Doneã€Cancelled**ã€‚åˆ›å»ºfutureçš„æ—¶å€™ï¼Œtaskä¸ºpendingï¼Œäº‹ä»¶å¾ªç¯è°ƒç”¨æ‰§è¡Œçš„æ—¶å€™å½“ç„¶å°±æ˜¯runningï¼Œè°ƒç”¨å®Œæ¯•è‡ªç„¶å°±æ˜¯doneï¼Œå¦‚æœéœ€è¦åœæ­¢äº‹ä»¶å¾ªç¯ï¼Œå°±éœ€è¦å…ˆæŠŠtaskå–æ¶ˆï¼Œå¯ä»¥ä½¿ç”¨**asyncio.Task**è·å–äº‹ä»¶å¾ªç¯çš„taskã€‚

ã€ç¨‹åºï¼šå…³äºfutureå¯¹è±¡çš„ä½¿ç”¨ã€‘
```
import asyncio
import functools

async def test1():
    print("1")
    await test2()
    print("2")
    return "stop"

async def test2():
    print("3")
    print("4")

def callback(param1,param2,future):
    print(param1,param2)
    print('Callback:',future.result())

loop = asyncio.get_event_loop()
task = asyncio.ensure_future(test1())
task.add_done_callback(functools.partial(callback,"param1","param2"))# ç»‘å®šå›è°ƒå‡½æ•°
loop.run_until_complete(task)
```
ã€è¯´æ˜ã€‘é€šè¿‡futureå¯¹è±¡çš„resultæ–¹æ³•å¯ä»¥è·å–åç¨‹å‡½æ•°çš„è¿”å›å€¼ï¼Œåˆ›å»ºtaskã€‚**test1()æ˜¯ä¸€ä¸ªåç¨‹å¯¹è±¡**ã€‚
å›è°ƒå‡½æ•°ä¸­çš„**futureå¯¹è±¡**å°±æ˜¯åˆ›å»ºçš„**taskå¯¹è±¡**ã€‚
ã€å¤šæ’æ’­ä¸€å¥ã€‘ï¼šå›è°ƒå‡½æ•°å¦‚æœéœ€è¦æ¥å—å¤šä¸ªå‚æ•°ï¼Œå¯ä»¥é€šè¿‡**åå‡½æ•°**å¯¼å…¥ã€‚

---

ã€å…³äºåç¨‹çš„åœæ­¢ã€‘

æ€ä¹ˆåœæ­¢æ‰§è¡Œåç¨‹å‘¢ï¼Ÿ
ã€ç¬¬ä¸€æ­¥ã€‘ï¼šéœ€è¦å…ˆå–æ¶ˆtask
ã€ç¬¬äºŒæ­¥ã€‘ï¼šåœæ­¢loopäº‹ä»¶å¾ªç¯ã€‚

```
import asyncio

async def test1():
    print("1")
    await asyncio.sleep(3)
    print("2")
    return "stop"

tasks = [
    asyncio.ensure_future(test1()),
    asyncio.ensure_future(test1()),
    asyncio.ensure_future(test1()),
]

loop = asyncio.get_event_loop()
try:
    loop.run_until_complete(asyncio.wait(tasks))
except KeyboardInterrupt as e:
    for task in asyncio.Task.all_tasks():
        task.cancel()
    loop.stop()
    loop.run_forever()
finally:
    loop.close()
```
---



ã€å‚è€ƒèµ„æ–™ã€‘[https://thief.one/2018/06/21/1/](https://thief.one/2018/06/21/1/ "Python3.5åç¨‹å­¦ä¹ ç ”ç©¶")
